@*@model IEnumerable<DemoWithAjax.Models.Student>*@
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Danh sách học sinh</h2>
<div class="row" style="margin-bottom:15px;">
    <div class="col-md-12">
        <a href="#" data-toggle="modal" data-target="#modalCreateUpdate" class="btn btn-primary">Thêm mới</a>
    </div>
</div>
<div class="row">
    <div class="input-group">
        <label for="searchBox">Tim kiem</label>
        <input type="search" id="searchBox" placeholder="Tim Kiem...">
    </div>
</div>
<table class="table table-bordered myTable">
    <thead>
        <tr>
            <th>STT</th>
            <th>Name</th>
            <th>Age</th>
            <th>Class</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="show_data" class="items"></tbody>
  
</table>
<!-- Button trigger modal -->
<!--<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
    Launch demo modal
</button>-->
<!-- Modal -->
<div class="modal fade" id="modalCreateUpdate" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel">Cập nhật thông tin học sinh</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div class="form-group">
                    <label for="exampleInputName">Họ và tên</label>
                    <input type="hidden" id="exampleId" value="0" />
                    <input type="text" class="form-control" id="exampleInputName" placeholder="Nhập họ và tên">
                    <span class="error text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="exampleInputAge">Tuổi</label>
                    <input type="text" class="form-control" id="exampleInputAge" placeholder="Nhập tuổi">
                    <span class="error text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="exampleInputClass">Lớp</label>
                    <select class="form-control" id="exampleInputClass">
                        <option value="">Chọn lớp</option>
                        @for (var k = 6; k < 13; k++)
                        {
                            <option value="@k">@k</option>
                        }
                    </select>
                    <span class="error text-danger"></span>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnLuu">Lưu Lại</button>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script>
        $(document).ready(function () {
            LoadData();
           
            $('#btnLuu').click(function () {
                var name = $('#exampleInputName').val();
                var age = $('#exampleInputAge').val();
                var _class = $('#exampleInputClass').val();
                var _id = $('#exampleId').val();
                var model = {
                    Name: name,
                    Age: age,
                    Class: _class,
                    Id: _id
                };
                if (Validate()) {
                    $.ajax({
                        url: '/student/Create',
                        type: 'POST',
                        data: model,
                        success: function (res) {
                            if (res.success) {
                                LoadData();
                                ResetInput();
                                $('#modalCreateUpdate').modal('hide');
                            }
                        }
                    });
                }

            });
            $('body').on('click', '.btnEdit', function () {
                var id = $(this).data('id');
                GetDataById(id);
            });

            $('body').on('click', '.btnDelete', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                if (parseInt(id) > 0) {
                    var conf = confirm('Ban co chac muon xoa ban ghi nay?');
                    if (conf)
                        DeleteRecord(id);
                }
            });

        });
        function LoadData() {
            $.ajax({
                url: '/student/getdata',
                type: 'GET',
                success: function (res) {
                    if (res.TotalItems > 0) {
                        var items = res.Data;
                        var html = "";
                        for (let i = 0; i < res.TotalItems; i++) {
                            html += "<tr id='trow_" + items[i].Id + "'>";
                            html += "<td>" + (i + 1) + "</td>";
                            html += "<td>" + items[i].Name + "</td>";
                            html += "<td>" + items[i].Age + "</td>";
                            html += "<td>" + items[i].Class + "</td>";
                            html += "<td><a data-id='" + items[i].Id + "' href='#' class='btn btn-warning btnEdit'>Sửa</a> | <a href='#' data-id='" + items[i].Id + "' class='btn btn-danger btnDelete'>Xóa</a></td>";
                            html += "</tr>";
                        }
                        $('#show_data').html(html);
                        let options = {
                            numberPerPage: 7, //So ban ghi tren mot trang
                            goBar: true, //Barra donde puedes digitar el numero de la pagina al que quiere ir
                            pageCounter: true, //Contador de paginas, en cual estas, de cuantas paginas
                        };

                        let filterOptions = {
                            el: '#searchBox' //Caja de texto para filtrar, puede ser una clase o un ID
                        };

                        paginate.init('.myTable', options, filterOptions);
                    }
                }
            });
        }

        function GetDataById(id) {
            $.ajax({
                url: '/student/getbyid',
                type: 'GET',
                data: { id: id },
                success: function (res) {
                    if (res.data != null) {
                        $('#exampleInputName').val(res.data.Name);
                        $('#exampleInputAge').val(res.data.Age);
                        $('#exampleInputClass').val(res.data.Class);
                        $('#exampleId').val(res.data.Id);
                        $('#modalCreateUpdate').modal('show');
                    }
                }
            });
        }

        function DeleteRecord(id) {
            $.ajax({
                url: '/Student/DeleteRecord',
                type: 'POST',
                data: { id: id }
               
                //success: function (rs) {
                //    if (rs.Success) {
                //        $('#trow_' + id).remove();
                //    } else {
                //        console.log("Co loi");
                //    }
                //}
            }).done(function (res) {
                if (res.Success) {
                        $('#trow_' + id).remove();
                    } 
            }).fail(function (err) {
                console.log(err);
            });
        }

        function Validate() {
            var check = false;
            var name = $('#exampleInputName').val();
            if (name === '') {
                $('#exampleInputName').next().html('Bạn chưa nhập họ và tên');
                check = false;
                return;
            } else {
                $('#exampleInputName').next().html('');
                check = true;
            }

            var age = $('#exampleInputAge').val();
            if (age === '') {
                $('#exampleInputAge').next().html('Bạn chưa tuổi');
                check = false;
                return;
            } else {
                $('#exampleInputAge').next().html('');
                check = true;
            }
            return check;
        }

        function ResetInput() {
            $('#exampleInputName').val('');
            $('#exampleInputAge').val('');
            $('#exampleInputClass').val();
        }
    </script>
}
